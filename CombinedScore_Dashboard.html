<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S&P 500 Combined Score Dashboard | JP Trust Learning</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Instrument+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0B0E11;--bg2:#111518;--bg3:#181D22;--card:#151A1F;
  --border:rgba(255,255,255,.06);--border2:rgba(255,255,255,.1);
  --gold:#E8B931;--gold2:#D4A72C;--gold-dim:rgba(232,185,49,.15);--gold-glow:rgba(232,185,49,.3);
  --emerald:#34D399;--emerald-dim:rgba(52,211,153,.15);
  --red:#F87171;--red-dim:rgba(248,113,113,.15);
  --blue:#60A5FA;--blue-dim:rgba(96,165,250,.15);
  --purple:#A78BFA;--purple-dim:rgba(167,139,250,.15);
  --orange:#FB923C;--orange-dim:rgba(251,146,60,.15);
  --cyan:#22D3EE;
  --text:#E8E6E1;--text2:#9CA3AF;--text3:#6B7280;
  --font-h:'DM Serif Display',serif;--font-b:'Instrument Sans',sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:var(--font-b);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;font-size:14px;line-height:1.5}
.container{max-width:1500px;margin:0 auto;padding:24px}

/* Header */
.header{text-align:center;padding:40px 0 30px;position:relative}
.header::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:600px;height:250px;background:radial-gradient(ellipse,rgba(232,185,49,.07) 0%,transparent 70%);pointer-events:none}
.header h1{font-family:var(--font-h);font-size:clamp(1.8rem,4vw,3rem);background:linear-gradient(135deg,#E8B931,#F5D76E,#E8B931,#D4A72C);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:1px;margin-bottom:6px}
.header .sub{font-size:.88rem;color:var(--text2);letter-spacing:3px;text-transform:uppercase;margin-bottom:14px}
.header .period{display:inline-block;padding:7px 24px;background:var(--bg3);border:1px solid var(--border2);border-radius:100px;color:var(--text2);font-size:.82rem}

/* Status */
.status-bar{display:flex;justify-content:center;gap:12px;margin-bottom:24px;flex-wrap:wrap;align-items:center}
.status-indicator{display:flex;align-items:center;gap:8px;font-weight:600;font-size:.82rem;padding:7px 18px;border-radius:50px;background:rgba(255,255,255,.03);border:1px solid var(--border2);transition:.3s}
.status-indicator.loading{color:var(--gold);border-color:var(--gold);background:var(--gold-dim)}
.status-indicator.success{color:var(--emerald);border-color:var(--emerald);background:var(--emerald-dim)}
.status-indicator.error{color:var(--red);border-color:var(--red);background:var(--red-dim)}

/* Weight Control */
.weight-control{background:var(--card);border:1px solid var(--border2);border-radius:14px;padding:20px 24px;margin-bottom:24px;display:flex;align-items:center;gap:20px;flex-wrap:wrap}
.weight-control .label{font-weight:600;font-size:.85rem;color:var(--gold);white-space:nowrap}
.slider-wrap{flex:1;min-width:220px;display:flex;align-items:center;gap:12px}
.slider-wrap .side{font-size:.72rem;color:var(--text3);white-space:nowrap;min-width:70px}
.slider-wrap .side.r{text-align:right}
#weightSlider{flex:1;-webkit-appearance:none;height:5px;border-radius:3px;background:linear-gradient(90deg,var(--blue),var(--gold),var(--emerald));outline:none}
#weightSlider::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:var(--gold);border:3px solid var(--bg);box-shadow:0 0 8px var(--gold-glow);cursor:pointer}
.w-display{display:flex;gap:10px;align-items:center}
.w-chip{padding:5px 12px;border-radius:7px;font-size:.75rem;font-weight:600}
.w-chip.news{background:var(--blue-dim);color:var(--blue)}
.w-chip.mom{background:var(--emerald-dim);color:var(--emerald)}
.preset-btns{display:flex;gap:5px}
.preset-btn{padding:5px 13px;border-radius:7px;border:1px solid var(--border2);background:transparent;color:var(--text2);font-size:.73rem;font-family:var(--font-b);cursor:pointer;transition:.2s}
.preset-btn:hover,.preset-btn.active{border-color:var(--gold);color:var(--gold);background:var(--gold-dim)}

/* Stats */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(145px,1fr));gap:10px;margin-bottom:24px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 14px;text-align:center;position:relative;overflow:hidden}
.stat-card::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--gold);opacity:.4}
.stat-card .v{font-family:var(--font-h);font-size:1.8rem;color:var(--gold);line-height:1.2}
.stat-card .l{font-size:.68rem;color:var(--text3);text-transform:uppercase;letter-spacing:1.5px;margin-top:3px}

/* Sections */
.section{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:20px}
.section-title{font-family:var(--font-h);font-size:1.2rem;color:var(--text);margin-bottom:16px;display:flex;align-items:center;gap:8px}
.section-title .dot{width:6px;height:6px;border-radius:50%;background:var(--gold)}
.charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px;margin-bottom:20px}
.chart-box{height:380px;position:relative}
.chart-legend-row{display:flex;justify-content:center;gap:16px;margin-top:10px;flex-wrap:wrap}
.chart-legend-item{display:flex;align-items:center;gap:5px;font-size:.73rem;color:var(--text2)}
.chart-legend-dot{width:8px;height:8px;border-radius:50%}

/* Filters */
.filters-row{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.filter-btn{padding:7px 14px;border-radius:7px;border:1px solid var(--border2);background:transparent;color:var(--text2);font-size:.78rem;font-family:var(--font-b);font-weight:500;cursor:pointer;transition:.2s}
.filter-btn:hover{border-color:var(--text3);color:var(--text)}
.filter-btn.active{background:var(--gold-dim);border-color:var(--gold);color:var(--gold)}
.search-box{padding:7px 12px;border-radius:7px;border:1px solid var(--border2);background:var(--bg3);color:var(--text);font-size:.82rem;font-family:var(--font-b);outline:none;width:150px;transition:.2s}
.search-box:focus{border-color:var(--gold)}
.search-box::placeholder{color:var(--text3)}
.results-count{font-size:.73rem;color:var(--text3);margin-left:auto}

/* Table */
.table-wrap{overflow-x:auto;border-radius:10px;border:1px solid var(--border)}
table{width:100%;border-collapse:collapse;font-size:.8rem}
thead th{background:var(--bg3);color:var(--text2);font-weight:600;font-size:.68rem;text-transform:uppercase;letter-spacing:.8px;padding:10px 8px;text-align:left;white-space:nowrap;cursor:pointer;user-select:none;border-bottom:1px solid var(--border2);position:sticky;top:0;z-index:2}
thead th:hover{color:var(--gold)}
thead th.sorted{color:var(--gold)}
thead th .arrow{font-size:.6rem;margin-left:2px}
tbody tr{border-bottom:1px solid var(--border);transition:background .15s;cursor:pointer}
tbody tr:hover{background:rgba(232,185,49,.04)}
tbody td{padding:8px;white-space:nowrap;vertical-align:middle}
.tk{font-weight:700;color:var(--gold);font-size:.88rem}
.tk .co{font-weight:400;font-size:.66rem;color:var(--text3);display:block;max-width:130px;overflow:hidden;text-overflow:ellipsis}
.score-bar{display:flex;align-items:center;gap:5px}
.score-bar .bar{flex:1;height:5px;background:var(--bg);border-radius:3px;overflow:hidden;max-width:60px}
.score-bar .fill{height:100%;border-radius:3px}
.score-bar .sv{font-weight:600;font-size:.8rem;min-width:28px}
.tier-badge{padding:2px 8px;border-radius:5px;font-size:.66rem;font-weight:700;letter-spacing:.4px;display:inline-block}
.tier-Platinum{background:var(--gold-dim);color:var(--gold);border:1px solid rgba(232,185,49,.3)}
.tier-Gold{background:rgba(212,167,44,.1);color:#D4A72C;border:1px solid rgba(212,167,44,.2)}
.tier-Silver{background:rgba(156,163,175,.1);color:#9CA3AF;border:1px solid rgba(156,163,175,.2)}
.tier-Bronze{background:rgba(205,127,50,.1);color:#CD7F32;border:1px solid rgba(205,127,50,.2)}
.tier-Monitor{background:rgba(107,114,128,.1);color:#6B7280;border:1px solid rgba(107,114,128,.15)}
.tag-badge{padding:2px 7px;border-radius:4px;font-size:.64rem;font-weight:600;white-space:nowrap}
.tag-DS{background:var(--emerald-dim);color:var(--emerald)}
.tag-NO{background:var(--blue-dim);color:var(--blue)}
.tag-HG{background:var(--purple-dim);color:var(--purple)}
.tag-MO{background:var(--orange-dim);color:var(--orange)}
.tag-DW{background:var(--red-dim);color:var(--red)}
.pos{color:var(--emerald)}.neg{color:var(--red)}.neu{color:var(--text2)}
.ni{display:inline-block;width:7px;height:7px;border-radius:50%;margin-right:3px}
.ni.y{background:var(--blue);box-shadow:0 0 5px var(--blue)}.ni.n{background:var(--text3);opacity:.25}
.wf{font-size:.68rem;color:var(--red);max-width:120px;overflow:hidden;text-overflow:ellipsis}

/* Pagination */
.page-nav{display:flex;justify-content:center;gap:5px;margin-top:14px;align-items:center}
.page-btn{padding:5px 10px;border-radius:5px;border:1px solid var(--border2);background:transparent;color:var(--text2);font-size:.78rem;font-family:var(--font-b);cursor:pointer}
.page-btn:hover{border-color:var(--gold);color:var(--gold)}
.page-btn.active{background:var(--gold-dim);border-color:var(--gold);color:var(--gold)}
.page-btn:disabled{opacity:.3;cursor:default}
.page-info{font-size:.73rem;color:var(--text3);margin:0 6px}

/* Detail Overlay */
.overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:100;backdrop-filter:blur(4px)}
.overlay.open{display:flex;align-items:center;justify-content:center}
.detail{background:var(--bg2);border:1px solid var(--border2);border-radius:18px;padding:28px;max-width:660px;width:92%;max-height:85vh;overflow-y:auto;position:relative}
.detail .close{position:absolute;top:14px;right:14px;background:var(--bg3);border:1px solid var(--border2);color:var(--text2);width:30px;height:30px;border-radius:7px;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center}
.detail .close:hover{color:var(--gold);border-color:var(--gold)}
.detail .dtk{font-family:var(--font-h);font-size:1.8rem;color:var(--gold)}
.detail .dco{color:var(--text2);font-size:.85rem;margin-bottom:20px}
.dsg{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px}
.dsc{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center}
.dsc .v{font-family:var(--font-h);font-size:1.5rem}
.dsc .l{font-size:.66rem;color:var(--text3);text-transform:uppercase;letter-spacing:1px}
.ddg{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-bottom:16px}
.dd{background:var(--bg3);border-radius:7px;padding:8px 4px;text-align:center}
.dd .v{font-weight:700;font-size:.88rem}.dd .l{font-size:.6rem;color:var(--text3)}
.dig{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-bottom:14px}
.di{display:flex;justify-content:space-between;padding:7px 10px;background:var(--bg3);border-radius:7px;font-size:.78rem}
.di .k{color:var(--text3)}.di .vv{font-weight:600}
.dcat{background:var(--gold-dim);border-left:3px solid var(--gold);border-radius:0 8px 8px 0;padding:12px 14px;margin-top:14px}
.dcat .l{font-size:.66rem;color:var(--gold);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px}
.dcat .v{color:var(--text);font-size:.85rem}

.footer{text-align:center;padding:24px 0;color:var(--text3);font-size:.78rem;border-top:1px solid var(--border);margin-top:30px}
.footer strong{color:var(--gold)}
.hidden{display:none!important}
@keyframes pulse{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
.loading-msg{text-align:center;padding:60px;color:var(--text2);font-size:1.1rem;animation:pulse 1.5s infinite}

@media(max-width:768px){
  .container{padding:14px 10px}
  .weight-control{flex-direction:column;align-items:stretch;gap:10px}
  .dsg{grid-template-columns:1fr}
  .ddg{grid-template-columns:repeat(3,1fr)}
  .dig{grid-template-columns:1fr}
  .chart-box{height:280px}
}
</style>
</head>
<body>
<div class="container">
  <header class="header">
    <h1>S&P 500 Combined Score</h1>
    <div class="sub">JP Trust Learning &bull; News Screening + Momentum Analysis</div>
    <div class="period" id="periodLabel">Loading...</div>
  </header>

  <div class="status-bar">
    <div id="status" class="status-indicator loading"><span>●</span> CONNECTING TO GITHUB...</div>
  </div>

  <div id="loadingMsg" class="loading-msg">/// LOADING DATA FROM GITHUB...</div>

  <div id="dashboard" class="hidden">
    <!-- Weight Control -->
    <div class="weight-control">
      <div class="label">Score Weight</div>
      <div class="slider-wrap">
        <div class="side">News 100%</div>
        <input type="range" id="weightSlider" min="0" max="100" value="50" step="5">
        <div class="side r">Momentum 100%</div>
      </div>
      <div class="w-display">
        <span class="w-chip news" id="wNews">News 50%</span>
        <span class="w-chip mom" id="wMom">Mom 50%</span>
      </div>
      <div class="preset-btns">
        <button class="preset-btn" data-v="40">Catalyst-First</button>
        <button class="preset-btn active" data-v="50">Balanced</button>
        <button class="preset-btn" data-v="60">Trend-First</button>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid" id="statsGrid"></div>

    <!-- Charts -->
    <div class="charts-grid">
      <div class="section">
        <div class="section-title"><span class="dot"></span>News Score vs Momentum Score</div>
        <div class="chart-box"><canvas id="scatterChart"></canvas></div>
        <div class="chart-legend-row">
          <div class="chart-legend-item"><div class="chart-legend-dot" style="background:var(--emerald)"></div>Double Strong</div>
          <div class="chart-legend-item"><div class="chart-legend-dot" style="background:var(--blue)"></div>News Only</div>
          <div class="chart-legend-item"><div class="chart-legend-dot" style="background:var(--purple)"></div>Hidden Gem</div>
          <div class="chart-legend-item"><div class="chart-legend-dot" style="background:var(--orange)"></div>Momentum Only</div>
          <div class="chart-legend-item"><div class="chart-legend-dot" style="background:var(--text3)"></div>Other</div>
        </div>
      </div>
      <div class="section">
        <div class="section-title"><span class="dot"></span>Combined Tier Distribution</div>
        <div class="chart-box"><canvas id="tierChart"></canvas></div>
      </div>
    </div>

    <!-- Stock Table -->
    <div class="section">
      <div class="section-title"><span class="dot"></span>All S&P 500 — Combined Ranking</div>
      <div class="filters-row">
        <button class="filter-btn active" data-f="all">All (499)</button>
        <button class="filter-btn" data-f="news">In News Screening</button>
        <button class="filter-btn" data-f="Platinum">Platinum</button>
        <button class="filter-btn" data-f="Gold">Gold</button>
        <button class="filter-btn" data-f="Silver">Silver</button>
        <button class="filter-btn" data-f="Bronze">Bronze</button>
        <button class="filter-btn" data-f="deal">Has Deal</button>
        <button class="filter-btn" data-f="DS">Double Strong</button>
        <button class="filter-btn" data-f="HG">Hidden Gem</button>
        <input type="text" class="search-box" id="searchBox" placeholder="Search ticker...">
        <span class="results-count" id="resultsCount"></span>
      </div>
      <div class="table-wrap" style="max-height:600px;overflow-y:auto">
        <table>
          <thead>
            <tr>
              <th data-col="rank" class="sorted">Rank <span class="arrow">▲</span></th>
              <th data-col="ticker">Ticker</th>
              <th data-col="combined">Combined <span class="arrow"></span></th>
              <th data-col="tier">Tier</th>
              <th data-col="tag">Signal</th>
              <th data-col="news_raw">News</th>
              <th data-col="mom">Momentum</th>
              <th data-col="mom_tier">Mom Tier</th>
              <th data-col="ret1y">Ret 1Y</th>
              <th data-col="rsi">RSI</th>
              <th data-col="penalty">Penalty</th>
              <th data-col="warning">Warning</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div class="page-nav" id="pageNav"></div>
    </div>
  </div>

  <!-- Detail Overlay -->
  <div class="overlay" id="overlay">
    <div class="detail" id="detailPanel"></div>
  </div>

  <footer class="footer">
    <p><strong>JP Trust Learning</strong> &bull; Combined Score Dashboard v1.0</p>
    <p style="margin-top:4px">News Screening + Momentum Analysis &bull; S&P 500</p>
  </footer>
</div>

<script>
// ============================================================
// CONFIG
// ============================================================
const CSV_URL = 'https://raw.githubusercontent.com/jptrustlearning/sp500/main/output_combined_score_sp500.csv';

let DATA = [];
let filtered = [];
let sortCol = 'rank';
let sortAsc = true;
let currentPage = 1;
const PAGE_SIZE = 50;
let newsWeight = 50;
let charts = {};

// ============================================================
// INIT: Fetch CSV from GitHub
// ============================================================
document.addEventListener('DOMContentLoaded', loadData);

async function loadData() {
  const statusEl = document.getElementById('status');
  try {
    const res = await fetch(CSV_URL);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const text = await res.text();
    DATA = parseCSV(text);
    
    statusEl.className = 'status-indicator success';
    statusEl.innerHTML = '<span>●</span> GITHUB DATA LOADED — ' + DATA.length + ' STOCKS';
    
    // Set period label
    if (DATA.length > 0) {
      document.getElementById('periodLabel').textContent = 'As of: ' + DATA[0].As_Of_Running;
    }
    
    document.getElementById('loadingMsg').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    
    recalcAndRender();
  } catch(e) {
    console.error(e);
    statusEl.className = 'status-indicator error';
    statusEl.innerHTML = '<span>●</span> FAILED TO LOAD — CHECK CONSOLE';
    document.getElementById('loadingMsg').textContent = 'Error loading data from GitHub. Please check the CSV URL.';
  }
}

function parseCSV(text) {
  const lines = text.trim().split('\n');
  const headers = parseCSVLine(lines[0]);
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const vals = parseCSVLine(lines[i]);
    if (vals.length < headers.length) continue;
    const obj = {};
    headers.forEach((h, idx) => obj[h] = vals[idx]);
    rows.push(obj);
  }
  return rows;
}

function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (ch === '"') { inQuotes = !inQuotes; }
    else if (ch === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
    else { current += ch; }
  }
  result.push(current.trim());
  return result;
}

// ============================================================
// RECALCULATE combined score based on user weight
// ============================================================
function recalcAndRender() {
  const nw = newsWeight / 100;
  const mw = 1 - nw;
  
  DATA.forEach(d => {
    const nn = parseFloat(d.News_Score_Norm) || 0;
    const mn = parseFloat(d.Mom_Score_Norm) || 0;
    d._combined = nn * nw + mn * mw;
    
    // Recalc tier
    if (d._combined >= 75) d._tier = 'Platinum';
    else if (d._combined >= 60) d._tier = 'Gold';
    else if (d._combined >= 45) d._tier = 'Silver';
    else if (d._combined >= 30) d._tier = 'Bronze';
    else d._tier = 'Monitor';
  });
  
  // Sort by combined score
  DATA.sort((a, b) => b._combined - a._combined);
  DATA.forEach((d, i) => d._rank = i + 1);
  
  applyFilter();
  renderStats();
  renderCharts();
}

// ============================================================
// FILTERS
// ============================================================
function applyFilter() {
  const activeBtn = document.querySelector('.filter-btn.active');
  const f = activeBtn ? activeBtn.dataset.f : 'all';
  const search = document.getElementById('searchBox').value.toUpperCase().trim();
  
  filtered = DATA.filter(d => {
    if (search && !d.Ticker.toUpperCase().includes(search)) return false;
    if (f === 'all') return true;
    if (f === 'news') return d.In_News_Screening === 'TRUE';
    if (f === 'deal') return d.Has_Deal === 'TRUE';
    if (f === 'DS') return d.Conviction_Tag === 'Double Strong';
    if (f === 'HG') return d.Conviction_Tag === 'Hidden Gem';
    if (['Platinum','Gold','Silver','Bronze','Monitor'].includes(f)) return d._tier === f;
    return true;
  });
  
  // Apply sort
  filtered.sort((a, b) => {
    let va, vb;
    switch(sortCol) {
      case 'rank': va = a._rank; vb = b._rank; break;
      case 'combined': va = a._combined; vb = b._combined; break;
      case 'news_raw': va = parseInt(a.News_Score_Raw)||0; vb = parseInt(b.News_Score_Raw)||0; break;
      case 'mom': va = parseFloat(a.Mom_Score)||0; vb = parseFloat(b.Mom_Score)||0; break;
      case 'ret1y': va = parseFloat(a.Ret_1Y_Pct)||0; vb = parseFloat(b.Ret_1Y_Pct)||0; break;
      case 'rsi': va = parseFloat(a.RSI_Value)||0; vb = parseFloat(b.RSI_Value)||0; break;
      case 'penalty': va = parseFloat(a.Penalty_Total)||0; vb = parseFloat(b.Penalty_Total)||0; break;
      case 'ticker': va = a.Ticker; vb = b.Ticker; return sortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
      default: va = a._rank; vb = b._rank;
    }
    return sortAsc ? va - vb : vb - va;
  });
  
  currentPage = 1;
  document.getElementById('resultsCount').textContent = filtered.length + ' stocks';
  renderTable();
}

// ============================================================
// RENDER TABLE
// ============================================================
function renderTable() {
  const tbody = document.getElementById('tableBody');
  const start = (currentPage - 1) * PAGE_SIZE;
  const page = filtered.slice(start, start + PAGE_SIZE);
  
  tbody.innerHTML = page.map(d => {
    const newsRaw = parseInt(d.News_Score_Raw) || 0;
    const momSc = parseFloat(d.Mom_Score) || 0;
    const comb = d._combined;
    const ret1y = parseFloat(d.Ret_1Y_Pct) || 0;
    const rsi = parseFloat(d.RSI_Value) || 0;
    const pen = parseFloat(d.Penalty_Total) || 0;
    const inNews = d.In_News_Screening === 'TRUE';
    const tag = d.Conviction_Tag;
    
    const tagCls = tag === 'Double Strong' ? 'DS' : tag === 'News Only' ? 'NO' : tag === 'Hidden Gem' ? 'HG' : tag === 'Momentum Only' ? 'MO' : tag === 'Double Weak' ? 'DW' : '';
    
    return `<tr data-ticker="${d.Ticker}">
      <td style="font-weight:600;color:var(--text2)">${d._rank}</td>
      <td class="tk">${inNews ? '<span class="ni y"></span>' : '<span class="ni n"></span>'}${d.Ticker}${d.Company ? '<span class="co">'+d.Company+'</span>' : ''}</td>
      <td><div class="score-bar"><span class="sv" style="color:${combColor(comb)}">${comb.toFixed(1)}</span><div class="bar"><div class="fill" style="width:${comb}%;background:${combColor(comb)}"></div></div></div></td>
      <td><span class="tier-badge tier-${d._tier}">${d._tier}</span></td>
      <td>${tagCls ? '<span class="tag-badge tag-'+tagCls+'">'+tag+'</span>' : ''}</td>
      <td style="color:${newsRaw > 0 ? 'var(--blue)' : 'var(--text3)'}">${newsRaw}</td>
      <td><div class="score-bar"><span class="sv" style="color:${momColor(momSc)}">${momSc.toFixed(1)}</span><div class="bar"><div class="fill" style="width:${momSc}%;background:${momColor(momSc)}"></div></div></div></td>
      <td style="font-size:.72rem;color:var(--text3)">${d.Mom_Tier}</td>
      <td class="${ret1y >= 0 ? 'pos' : 'neg'}">${ret1y >= 0 ? '+' : ''}${ret1y.toFixed(1)}%</td>
      <td style="color:${rsiColor(rsi)}">${rsi.toFixed(0)}</td>
      <td style="color:${pen < 0 ? 'var(--red)' : 'var(--text3)'}">${pen}</td>
      <td class="wf">${d.Warning_Flags || ''}</td>
    </tr>`;
  }).join('');
  
  renderPageNav();
  
  // Row click
  tbody.querySelectorAll('tr').forEach(tr => {
    tr.addEventListener('click', () => showDetail(tr.dataset.ticker));
  });
}

function combColor(v) { return v >= 75 ? 'var(--gold)' : v >= 60 ? '#D4A72C' : v >= 45 ? 'var(--text)' : v >= 30 ? 'var(--text2)' : 'var(--text3)'; }
function momColor(v) { return v >= 75 ? 'var(--emerald)' : v >= 60 ? '#8BD4B0' : v >= 45 ? 'var(--text)' : 'var(--text2)'; }
function rsiColor(v) { return v >= 70 ? 'var(--red)' : v >= 50 ? 'var(--emerald)' : v >= 30 ? 'var(--text2)' : 'var(--red)'; }

function renderPageNav() {
  const nav = document.getElementById('pageNav');
  const totalPages = Math.ceil(filtered.length / PAGE_SIZE);
  if (totalPages <= 1) { nav.innerHTML = ''; return; }
  
  let html = `<button class="page-btn" onclick="goPage(${currentPage-1})" ${currentPage===1?'disabled':''}>‹</button>`;
  for (let i = 1; i <= totalPages; i++) {
    if (totalPages > 7 && Math.abs(i - currentPage) > 2 && i !== 1 && i !== totalPages) {
      if (i === currentPage - 3 || i === currentPage + 3) html += '<span class="page-info">...</span>';
      continue;
    }
    html += `<button class="page-btn ${i===currentPage?'active':''}" onclick="goPage(${i})">${i}</button>`;
  }
  html += `<button class="page-btn" onclick="goPage(${currentPage+1})" ${currentPage===totalPages?'disabled':''}>›</button>`;
  nav.innerHTML = html;
}
window.goPage = function(p) { currentPage = p; renderTable(); document.querySelector('.table-wrap').scrollTop = 0; }

// ============================================================
// RENDER STATS
// ============================================================
function renderStats() {
  const inNews = DATA.filter(d => d.In_News_Screening === 'TRUE').length;
  const plat = DATA.filter(d => d._tier === 'Platinum').length;
  const gold = DATA.filter(d => d._tier === 'Gold').length;
  const ds = DATA.filter(d => d.Conviction_Tag === 'Double Strong').length;
  const hg = DATA.filter(d => d.Conviction_Tag === 'Hidden Gem').length;
  const avgComb = (DATA.reduce((s,d) => s + d._combined, 0) / DATA.length).toFixed(1);
  
  document.getElementById('statsGrid').innerHTML = `
    <div class="stat-card"><div class="v">${DATA.length}</div><div class="l">Total Stocks</div></div>
    <div class="stat-card"><div class="v">${inNews}</div><div class="l">In News Screening</div></div>
    <div class="stat-card"><div class="v">${plat}</div><div class="l">Platinum Tier</div></div>
    <div class="stat-card"><div class="v">${gold}</div><div class="l">Gold Tier</div></div>
    <div class="stat-card"><div class="v">${ds}</div><div class="l">Double Strong</div></div>
    <div class="stat-card"><div class="v">${hg}</div><div class="l">Hidden Gem</div></div>
    <div class="stat-card"><div class="v">${avgComb}</div><div class="l">Avg Combined</div></div>
  `;
}

// ============================================================
// RENDER CHARTS
// ============================================================
function renderCharts() {
  renderScatter();
  renderTierChart();
}

function renderScatter() {
  const ctx = document.getElementById('scatterChart').getContext('2d');
  if (charts.scatter) charts.scatter.destroy();
  
  // Only plot stocks with news or top 50 by momentum
  const newsStocks = DATA.filter(d => d.In_News_Screening === 'TRUE');
  const topMom = DATA.filter(d => d.In_News_Screening !== 'TRUE').slice(0, 20);
  const plotData = [...newsStocks, ...topMom];
  
  const tagColor = t => t === 'Double Strong' ? '#34D399' : t === 'News Only' ? '#60A5FA' : t === 'Hidden Gem' ? '#A78BFA' : t === 'Momentum Only' ? '#FB923C' : t === 'Double Weak' ? '#F87171' : '#6B7280';
  
  charts.scatter = new Chart(ctx, {
    type: 'scatter',
    data: {
      datasets: [{
        data: plotData.map(d => ({ x: parseFloat(d.News_Score_Raw)||0, y: parseFloat(d.Mom_Score)||0, t: d.Ticker, tag: d.Conviction_Tag })),
        backgroundColor: plotData.map(d => tagColor(d.Conviction_Tag)),
        borderColor: plotData.map(d => tagColor(d.Conviction_Tag)),
        borderWidth: 1.5,
        pointRadius: plotData.map(d => d.In_News_Screening === 'TRUE' ? 7 : 5),
        pointHoverRadius: 10
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1e293b', borderColor: '#E8B931', borderWidth: 1,
          titleColor: '#E8B931', bodyColor: '#E8E6E1', padding: 10, displayColors: false,
          callbacks: {
            title: items => items[0].raw.t,
            label: item => ['News Score: ' + item.raw.x, 'Momentum: ' + item.raw.y.toFixed(1), item.raw.tag || '']
          }
        }
      },
      scales: {
        x: { title: { display: true, text: 'News Score (Raw)', color: '#6B7280' }, grid: { color: 'rgba(255,255,255,.04)' }, ticks: { color: '#6B7280' } },
        y: { title: { display: true, text: 'Momentum Score', color: '#6B7280' }, grid: { color: 'rgba(255,255,255,.04)' }, ticks: { color: '#6B7280' } }
      }
    }
  });
}

function renderTierChart() {
  const ctx = document.getElementById('tierChart').getContext('2d');
  if (charts.tier) charts.tier.destroy();
  
  const tiers = ['Platinum','Gold','Silver','Bronze','Monitor'];
  const counts = tiers.map(t => DATA.filter(d => d._tier === t).length);
  const colors = ['#E8B931','#D4A72C','#9CA3AF','#CD7F32','#4B5563'];
  
  // Also show conviction tag breakdown as stacked bars
  const tagTypes = ['Double Strong','News Only','Hidden Gem','Momentum Only','Double Weak',''];
  const tagColors = ['#34D399','#60A5FA','#A78BFA','#FB923C','#F87171','#374151'];
  const tagLabels = ['Double Strong','News Only','Hidden Gem','Mom Only','Double Weak','Other'];
  
  const datasets = tagTypes.map((tag, i) => ({
    label: tagLabels[i],
    data: tiers.map(tier => DATA.filter(d => d._tier === tier && d.Conviction_Tag === tag).length),
    backgroundColor: tagColors[i],
    borderRadius: 3
  }));
  
  charts.tier = new Chart(ctx, {
    type: 'bar',
    data: { labels: tiers, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { color: '#9CA3AF', font: { size: 10, family: 'Instrument Sans' }, boxWidth: 10 } }
      },
      scales: {
        x: { stacked: true, grid: { display: false }, ticks: { color: '#9CA3AF', font: { weight: '600' } } },
        y: { stacked: true, grid: { color: 'rgba(255,255,255,.04)' }, ticks: { color: '#6B7280' } }
      }
    }
  });
}

// ============================================================
// DETAIL PANEL
// ============================================================
function showDetail(ticker) {
  const d = DATA.find(r => r.Ticker === ticker);
  if (!d) return;
  
  const inNews = d.In_News_Screening === 'TRUE';
  const hasDeal = d.Has_Deal === 'TRUE';
  const ret1y = parseFloat(d.Ret_1Y_Pct)||0;
  const ret6m = parseFloat(d.Ret_6M_Pct)||0;
  const ret1m = parseFloat(d.Ret_1M_Pct)||0;
  const ret1w = parseFloat(d.Ret_1W_Pct)||0;
  const rsi = parseFloat(d.RSI_Value)||0;
  const pen = parseFloat(d.Penalty_Total)||0;
  
  const panel = document.getElementById('detailPanel');
  panel.innerHTML = `
    <button class="close" onclick="closeDetail()">✕</button>
    <div class="dtk">${d.Ticker} <span class="tier-badge tier-${d._tier}" style="font-size:.7rem;vertical-align:middle">${d._tier}</span>
    ${d.Conviction_Tag ? '<span class="tag-badge tag-'+(d.Conviction_Tag==='Double Strong'?'DS':d.Conviction_Tag==='News Only'?'NO':d.Conviction_Tag==='Hidden Gem'?'HG':d.Conviction_Tag==='Momentum Only'?'MO':'DW')+'" style="font-size:.65rem;vertical-align:middle">'+d.Conviction_Tag+'</span>' : ''}
    </div>
    <div class="dco">${d.Company || d.Ticker} ${d.Sector ? '• '+d.Sector : ''} ${d.Market_Cap ? '• '+d.Market_Cap : ''}</div>
    
    <div class="dsg">
      <div class="dsc"><div class="v" style="color:${combColor(d._combined)}">${d._combined.toFixed(1)}</div><div class="l">Combined</div></div>
      <div class="dsc"><div class="v" style="color:${parseInt(d.News_Score_Raw)>0?'var(--blue)':'var(--text3)'}">${d.News_Score_Raw}</div><div class="l">News Score</div></div>
      <div class="dsc"><div class="v" style="color:${momColor(parseFloat(d.Mom_Score))}">${parseFloat(d.Mom_Score).toFixed(1)}</div><div class="l">Momentum</div></div>
    </div>
    
    <div style="font-size:.72rem;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Momentum Dimensions (each /20)</div>
    <div class="ddg">
      <div class="dd"><div class="v">${parseFloat(d.D1_ReturnRank).toFixed(1)}</div><div class="l">Return</div></div>
      <div class="dd"><div class="v">${parseFloat(d.D2_VolumeRank).toFixed(1)}</div><div class="l">Volume</div></div>
      <div class="dd"><div class="v">${parseFloat(d.D3_RSI).toFixed(0)}</div><div class="l">RSI</div></div>
      <div class="dd"><div class="v">${parseFloat(d.D4_MA).toFixed(0)}</div><div class="l">MA</div></div>
      <div class="dd"><div class="v">${parseFloat(d.D5_Volatility).toFixed(0)}</div><div class="l">Volatility</div></div>
    </div>
    
    <div class="dig">
      <div class="di"><span class="k">Return 1Y</span><span class="vv ${ret1y>=0?'pos':'neg'}">${ret1y>=0?'+':''}${ret1y.toFixed(1)}%</span></div>
      <div class="di"><span class="k">Return 6M</span><span class="vv ${ret6m>=0?'pos':'neg'}">${ret6m>=0?'+':''}${ret6m.toFixed(1)}%</span></div>
      <div class="di"><span class="k">Return 1M</span><span class="vv ${ret1m>=0?'pos':'neg'}">${ret1m>=0?'+':''}${ret1m.toFixed(1)}%</span></div>
      <div class="di"><span class="k">Return 1W</span><span class="vv ${ret1w>=0?'pos':'neg'}">${ret1w>=0?'+':''}${ret1w.toFixed(1)}%</span></div>
      <div class="di"><span class="k">RSI</span><span class="vv" style="color:${rsiColor(rsi)}">${rsi.toFixed(1)}</span></div>
      <div class="di"><span class="k">Golden Cross</span><span class="vv">${d.Golden_Cross === 'True' ? '✅ Yes' : '❌ No'}</span></div>
      <div class="di"><span class="k">Volatility</span><span class="vv">${parseFloat(d.Volatility_Pct).toFixed(1)}%</span></div>
      <div class="di"><span class="k">Penalty</span><span class="vv" style="color:${pen<0?'var(--red)':'var(--text3)'}">${pen}</span></div>
      <div class="di"><span class="k">Price</span><span class="vv">$${parseFloat(d.Price).toFixed(2)}</span></div>
      <div class="di"><span class="k">Mom Tier</span><span class="vv">${d.Mom_Tier}</span></div>
      ${d.News_Tier ? '<div class="di"><span class="k">News Tier</span><span class="vv">'+d.News_Tier+'</span></div>' : ''}
      ${d.Upside_Pct ? '<div class="di"><span class="k">Upside</span><span class="vv pos">'+d.Upside_Pct+'</span></div>' : ''}
    </div>
    
    ${d.Warning_Flags ? '<div style="padding:8px 12px;background:var(--red-dim);border-left:3px solid var(--red);border-radius:0 7px 7px 0;margin-bottom:12px"><div style="font-size:.66rem;color:var(--red);text-transform:uppercase;letter-spacing:1px;margin-bottom:2px">Warning Flags</div><div style="color:var(--red);font-size:.82rem">'+d.Warning_Flags+'</div></div>' : ''}
    
    ${inNews && d.Signals ? '<div style="margin-bottom:12px"><div style="font-size:.66rem;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">News Signals</div><div style="display:flex;flex-wrap:wrap;gap:4px">'+d.Signals.split(',').map(s=>'<span style="padding:2px 8px;background:var(--blue-dim);border:1px solid rgba(96,165,250,.3);border-radius:12px;font-size:.7rem;color:var(--blue)">'+s.trim()+'</span>').join('')+'</div></div>' : ''}
    
    ${d.Catalyst ? '<div class="dcat"><div class="l">Catalyst</div><div class="v">'+d.Catalyst+'</div></div>' : ''}
    ${hasDeal ? '<div class="dcat" style="border-left-color:var(--purple);background:var(--purple-dim);margin-top:8px"><div class="l" style="color:var(--purple)">Deal</div><div class="v">'+d.Deal_Partner+' — '+d.Deal_Value+'</div></div>' : ''}
    ${d.Top_Sources ? '<div style="margin-top:10px;font-size:.75rem;color:var(--text3)">Sources: '+d.Top_Sources+'</div>' : ''}
  `;
  
  document.getElementById('overlay').classList.add('open');
}

function closeDetail() { document.getElementById('overlay').classList.remove('open'); }
document.getElementById('overlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeDetail(); });
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeDetail(); });

// ============================================================
// EVENT HANDLERS
// ============================================================

// Weight slider
document.getElementById('weightSlider').addEventListener('input', function() {
  const mw = parseInt(this.value);
  newsWeight = 100 - mw;
  document.getElementById('wNews').textContent = 'News ' + newsWeight + '%';
  document.getElementById('wMom').textContent = 'Mom ' + mw + '%';
  
  // Update preset buttons
  document.querySelectorAll('.preset-btn').forEach(b => {
    b.classList.toggle('active', parseInt(b.dataset.v) === mw);
  });
});

document.getElementById('weightSlider').addEventListener('change', function() {
  recalcAndRender();
});

// Presets
document.querySelectorAll('.preset-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const v = parseInt(this.dataset.v);
    document.getElementById('weightSlider').value = v;
    newsWeight = 100 - v;
    document.getElementById('wNews').textContent = 'News ' + newsWeight + '%';
    document.getElementById('wMom').textContent = 'Mom ' + (100 - newsWeight) + '%';
    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    recalcAndRender();
  });
});

// Filter buttons
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    applyFilter();
  });
});

// Search
document.getElementById('searchBox').addEventListener('input', applyFilter);

// Column sort
document.querySelectorAll('thead th[data-col]').forEach(th => {
  th.addEventListener('click', function() {
    const col = this.dataset.col;
    if (sortCol === col) sortAsc = !sortAsc;
    else { sortCol = col; sortAsc = col === 'rank' || col === 'ticker'; }
    
    document.querySelectorAll('thead th').forEach(h => {
      h.classList.remove('sorted');
      const arrow = h.querySelector('.arrow');
      if (arrow) arrow.textContent = '';
    });
    this.classList.add('sorted');
    const arrow = this.querySelector('.arrow');
    if (arrow) arrow.textContent = sortAsc ? '▲' : '▼';
    
    applyFilter();
  });
});
</script>
</body>
</html>
